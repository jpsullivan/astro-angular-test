---
export interface Props {
  id?: string;
  class?: string;
  [key: string]: any;
}

const { id = "dropdown", class: className = "", ...rest } = Astro.props;
---

<div
  data-dropdown="true"
  aria-haspopup="listbox"
  aria-expanded="false"
  class:list={["stl-ui-dropdown stl-ui-not-prose not-content", className]}
  data-dropdown-id={id}
  {...rest}
>
  <slot />
</div>

<script>
  class DropdownController {
    constructor(element: HTMLElement) {
      // Prevent duplicate initialization
      if ((element as any).__dropdownController) {
        return (element as any).__dropdownController;
      }

      this.element = element;
      this.trigger = element.querySelector('[data-part="trigger"]') as HTMLButtonElement;
      this.menu = element.querySelector('[data-part="menu"]') as HTMLElement;
      this.items = Array.from(element.querySelectorAll('[data-part="item"]')) as HTMLButtonElement[];

      if (!this.trigger || !this.menu) return;

      (element as any).__dropdownController = this;
      this.init();
    }

    element!: HTMLElement;
    trigger!: HTMLButtonElement;
    menu!: HTMLElement;
    items!: HTMLButtonElement[];
    isOpen = false;

    init() {
      // Toggle dropdown on trigger click
      this.trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggle();
      });

      // Handle item selection
      this.items.forEach((item) => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          this.selectItem(item);
          this.close();
        });
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (!this.element.contains(e.target as Node) && this.isOpen) {
          this.close();
        }
      });

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.isOpen) {
          this.close();
        }
      });
    }

    toggle() {
      if (this.isOpen) {
        this.close();
      } else {
        this.open();
      }
    }

    open() {
      this.isOpen = true;
      this.element.setAttribute('aria-expanded', 'true');
      this.menu.setAttribute('data-state', 'open');
      this.menu.setAttribute('aria-hidden', 'false');
      this.menu.style.display = 'flex';
      this.menu.style.flexDirection = 'column';
    }

    close() {
      this.isOpen = false;
      this.element.setAttribute('aria-expanded', 'false');
      this.menu.setAttribute('data-state', 'closed');
      this.menu.setAttribute('aria-hidden', 'true');
      this.menu.style.display = 'none';
    }

    selectItem(selectedItem: HTMLButtonElement) {
      const value = selectedItem.getAttribute('data-value');

      // Update all items aria-selected
      this.items.forEach((item) => {
        item.setAttribute('aria-selected', item === selectedItem ? 'true' : 'false');
      });

      // Update trigger value
      this.trigger.setAttribute('data-value', value || '');

      // Update trigger content with selected item's template
      const template = selectedItem.querySelector('[data-part="selected-template"]');
      const triggerSelected = this.trigger.querySelector('[data-part="trigger-selected"]');

      if (template && triggerSelected) {
        triggerSelected.innerHTML = template.innerHTML;
      }

      // Dispatch custom event for external listeners
      this.element.dispatchEvent(new CustomEvent('dropdown:change', {
        detail: { value },
        bubbles: true,
      }));
    }
  }

  // Initialize all dropdowns on the page
  function initDropdowns() {
    const dropdowns = document.querySelectorAll('[data-dropdown="true"]');
    dropdowns.forEach((dropdown) => {
      new DropdownController(dropdown as HTMLElement);
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDropdowns);
  } else {
    initDropdowns();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initDropdowns);
</script>
